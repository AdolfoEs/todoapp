<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Restablecer contrase√±a - FluxList</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/icons/icon-192.svg" type="image/svg+xml" />
    <meta name="theme-color" content="#5b21b6" />
  </head>
  <body class="page-login">
    <div class="login-bg-blobs" aria-hidden="true">
      <div class="login-blob login-blob--purple"></div>
      <div class="login-blob login-blob--blue"></div>
      <div class="login-blob login-blob--pink"></div>
    </div>
    <div class="reset-password-page">
      <div class="login-card reset-password-card">
        <div class="login-card-icon" aria-hidden="true">üîë</div>
        <h1 class="login-card-title">Restablecer contrase√±a</h1>
        <p class="reset-password-subtitle">Elige una nueva contrase√±a para tu cuenta FluxList.</p>

        <div id="invalidTokenMessage" class="login-message login-message--error" style="display: none;">
          Enlace inv√°lido o expirado. Solicita uno nuevo desde la pantalla de inicio de sesi√≥n.
        </div>
        <a id="backToLoginLink" href="/login.html" class="login-link" style="display: none;">Volver al inicio de sesi√≥n</a>

        <form id="resetPasswordForm" class="auth-form" style="display: none;">
          <input type="hidden" id="resetToken" name="token" />
          <div class="field">
            <label class="label" for="newPassword">Nueva contrase√±a</label>
            <div class="input-wrap-password">
              <input id="newPassword" class="input login-input" type="password" placeholder="********" autocomplete="new-password" required minlength="8" />
              <button type="button" id="toggleNewPass" class="password-toggle" aria-label="Mostrar contrase√±a">üëÅ</button>
            </div>
          </div>
          <div class="password-requirements" id="resetReqs">
            <div id="req-length">‚¨ú M√≠nimo 8 caracteres</div>
            <div id="req-upper">‚¨ú Al menos una may√∫scula</div>
            <div id="req-number">‚¨ú Al menos un n√∫mero</div>
          </div>
          <div class="field">
            <label class="label" for="confirmPassword">Confirmar contrase√±a</label>
            <div class="input-wrap-password">
              <input id="confirmPassword" class="input login-input" type="password" placeholder="Repite tu contrase√±a" autocomplete="new-password" required minlength="8" />
              <button type="button" id="toggleConfirmPass" class="password-toggle" aria-label="Mostrar contrase√±a">üëÅ</button>
            </div>
            <div id="resetPasswordMatch" class="login-password-match" style="display: none;"></div>
          </div>
          <div id="resetMessage" class="login-message" style="display: none;"></div>
          <button type="submit" class="btn btn-login-gradient" id="resetSubmitBtn">Restablecer contrase√±a</button>
        </form>
      </div>
    </div>
    <script>
      const API_URL = '';
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token') || '';

      const invalidTokenMessage = document.getElementById('invalidTokenMessage');
      const backToLoginLink = document.getElementById('backToLoginLink');
      const resetPasswordForm = document.getElementById('resetPasswordForm');
      const resetTokenInput = document.getElementById('resetToken');
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const resetMessage = document.getElementById('resetMessage');
      const resetSubmitBtn = document.getElementById('resetSubmitBtn');

      function showInvalidToken() {
        invalidTokenMessage.style.display = 'block';
        backToLoginLink.style.display = 'inline-block';
        resetPasswordForm.style.display = 'none';
      }

      function showForm() {
        invalidTokenMessage.style.display = 'none';
        backToLoginLink.style.display = 'none';
        resetTokenInput.value = token;
        resetPasswordForm.style.display = 'block';
      }

      if (!token) {
        showInvalidToken();
      } else {
        fetch(`${API_URL}/reset-password/validate?token=${encodeURIComponent(token)}`)
          .then(res => res.json())
          .then(data => {
            if (data.valid) showForm();
            else showInvalidToken();
          })
          .catch(() => showInvalidToken());
      }

      function updateReq(id, valid) {
        const el = document.getElementById(id);
        if (!el) return;
        const text = el.textContent.substring(2).trim();
        el.textContent = (valid ? '‚úÖ ' : '‚¨ú ') + text;
        el.style.color = valid ? '#0a0' : '#888';
      }
      newPasswordInput.addEventListener('input', () => {
        const p = newPasswordInput.value;
        updateReq('req-length', p.length >= 8);
        updateReq('req-upper', /[A-Z]/.test(p));
        updateReq('req-number', /[0-9]/.test(p));
      });

      const resetPasswordMatch = document.getElementById('resetPasswordMatch');
      function checkMatch() {
        const a = newPasswordInput.value;
        const b = confirmPasswordInput.value;
        if (b.length === 0) { resetPasswordMatch.style.display = 'none'; return; }
        resetPasswordMatch.style.display = 'block';
        if (a === b) {
          resetPasswordMatch.style.color = '#0a0';
          resetPasswordMatch.textContent = '‚úÖ Las contrase√±as coinciden';
        } else {
          resetPasswordMatch.style.color = '#c00';
          resetPasswordMatch.textContent = '‚ùå Las contrase√±as no coinciden';
        }
      }
      confirmPasswordInput.addEventListener('input', checkMatch);
      newPasswordInput.addEventListener('input', checkMatch);

      document.getElementById('toggleNewPass').addEventListener('click', () => {
        const inp = newPasswordInput;
        inp.type = inp.type === 'password' ? 'text' : 'password';
      });
      document.getElementById('toggleConfirmPass').addEventListener('click', () => {
        const inp = confirmPasswordInput;
        inp.type = inp.type === 'password' ? 'text' : 'password';
      });

      resetPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        if (newPassword !== confirmPassword) {
          resetMessage.style.display = 'block';
          resetMessage.className = 'login-message login-message--error';
          resetMessage.textContent = 'Las contrase√±as no coinciden.';
          return;
        }
        if (newPassword.length < 8 || !/[A-Z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
          resetMessage.style.display = 'block';
          resetMessage.className = 'login-message login-message--error';
          resetMessage.textContent = 'La contrase√±a debe tener al menos 8 caracteres, una may√∫scula y un n√∫mero.';
          return;
        }
        resetMessage.style.display = 'none';
        resetSubmitBtn.disabled = true;
        try {
          const res = await fetch(`${API_URL}/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, newPassword, confirmPassword })
          });
          const data = await res.json();
          if (!res.ok) {
            resetMessage.style.display = 'block';
            resetMessage.className = 'login-message login-message--error';
            resetMessage.textContent = data.error || (data.details && data.details.length ? data.details.join(', ') : 'Error al restablecer.');
            resetSubmitBtn.disabled = false;
            return;
          }
          resetMessage.style.display = 'block';
          resetMessage.className = 'login-message login-message--ok';
          resetMessage.textContent = 'Contrase√±a actualizada. Redirigiendo al inicio de sesi√≥n...';
          setTimeout(() => { window.location.href = '/login.html?reset=ok'; }, 1500);
        } catch (err) {
          resetMessage.style.display = 'block';
          resetMessage.className = 'login-message login-message--error';
          resetMessage.textContent = 'Error de conexi√≥n.';
          resetSubmitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
