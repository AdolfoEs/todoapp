<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - FluxList</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/icons/icon-192.svg" type="image/svg+xml" />
    <meta name="theme-color" content="#5b21b6" />
  </head>

  <body class="page-login">
    <div class="login-bg-blobs" aria-hidden="true">
      <div class="login-blob login-blob--purple"></div>
      <div class="login-blob login-blob--blue"></div>
      <div class="login-blob login-blob--pink"></div>
    </div>
    <div class="login-page" role="main">
      <!-- Columna izquierda: marketing -->
      <section class="login-hero">
        <div class="login-pill">
          <span class="login-pill-icon">âœ¨ ğŸš€</span>
          <span>La mejor app de tareas inteligentes 2026</span>
        </div>
        <h1 class="login-brand">FluxList</h1>
        <p class="login-tagline">Agenda inteligente que se adapta a ti. Cada tarea tiene su propia herramienta especializada.</p>

        <div class="login-features">
          <div class="login-feature-card">
            <div class="login-feature-icon login-feature-icon--pink">ğŸ§ </div>
            <div class="login-feature-text">
              <strong>Agenda Inteligente</strong>
              <span>Sub-aplicaciones adaptadas a cada tipo de tarea</span>
            </div>
          </div>
          <div class="login-feature-card">
            <div class="login-feature-icon login-feature-icon--orange">âš¡</div>
            <div class="login-feature-text">
              <strong>Ultra RÃ¡pido</strong>
              <span>Organiza tu dÃ­a en segundos con herramientas personalizadas</span>
            </div>
          </div>
          <div class="login-feature-card">
            <div class="login-feature-icon login-feature-icon--blue">â—</div>
            <div class="login-feature-text">
              <strong>Enfoque Total</strong>
              <span>Seguimiento especÃ­fico: calorÃ­as, libros, ejercicio y mÃ¡s</span>
            </div>
          </div>
        </div>

        <div class="login-social">
          <div class="login-social-avatars" aria-hidden="true">
            <span></span><span></span><span></span><span></span>
          </div>
          <span class="login-social-stars">â˜…â˜…â˜…â˜…â˜…</span>
          <span class="login-social-text">+10,000 usuarios organizados</span>
        </div>
      </section>

      <!-- Columna derecha: formulario -->
      <div class="login-card-wrap">
        <div class="login-card">
          <div class="login-card-icon" aria-hidden="true">âœ“</div>

          <div id="loginHeadLogin" class="login-card-head">
            <h2 class="login-card-title">Â¡Bienvenido de vuelta!</h2>
            <p class="login-card-subtitle">Inicia sesiÃ³n para continuar</p>
          </div>
          <div id="loginHeadRegister" class="login-card-head" style="display: none;">
            <h2 class="login-card-title">Â¡Ãšnete ahora!</h2>
            <p class="login-card-subtitle">Crea tu cuenta gratuita</p>
          </div>

          <div class="filters login-card-tabs" role="tablist">
            <button class="chip is-active" id="tabLogin" type="button">Iniciar SesiÃ³n</button>
            <button class="chip" id="tabRegister" type="button">Registrarse</button>
          </div>

          <!-- Login Form -->
          <form id="loginForm" class="auth-form">
            <div class="field">
              <label class="label" for="loginUser">Usuario</label>
              <input id="loginUser" class="input login-input" type="text" placeholder="Tu nombre de usuario" autocomplete="username" required />
            </div>
            <div class="field">
              <label class="label" for="loginPass">ContraseÃ±a</label>
              <div class="input-wrap-password">
                <input id="loginPass" class="input login-input" type="password" placeholder="Tu contraseÃ±a" autocomplete="current-password" required />
                <button type="button" id="toggleLoginPass" class="password-toggle" aria-label="Mostrar contraseÃ±a" title="Mostrar contraseÃ±a">ğŸ‘</button>
              </div>
            </div>
            <a href="#" id="linkForgotPass" class="login-link">Â¿Olvidaste tu contraseÃ±a?</a>
            <button type="submit" class="btn btn-login-gradient">
              Iniciar SesiÃ³n â†’
            </button>
          </form>

          <!-- Register Form (hidden by default) -->
          <form id="registerForm" class="auth-form" style="display: none;">
            <div class="field">
              <label class="label" for="regUser">Nombre de usuario</label>
              <input id="regUser" class="input login-input" type="text" placeholder="Tu nombre" autocomplete="username" required />
            </div>
            <div class="field">
              <label class="label" for="regEmail">Email</label>
              <input id="regEmail" class="input login-input" type="email" placeholder="tu@email.com" autocomplete="email" />
            </div>
            <div class="field">
              <label class="label" for="regPass">ContraseÃ±a</label>
              <div class="input-wrap-password">
                <input id="regPass" class="input login-input" type="password" placeholder="********" autocomplete="new-password" required minlength="8" />
                <button type="button" id="toggleRegPass" class="password-toggle" aria-label="Mostrar contraseÃ±a" title="Mostrar contraseÃ±a">ğŸ‘</button>
              </div>
            </div>
            <div class="field">
              <label class="label" for="regPassConfirm">Confirmar ContraseÃ±a</label>
              <div class="input-wrap-password">
                <input id="regPassConfirm" class="input login-input" type="password" placeholder="Repite tu contraseÃ±a" autocomplete="new-password" required minlength="8" />
                <button type="button" id="toggleRegPassConfirm" class="password-toggle" aria-label="Mostrar contraseÃ±a" title="Mostrar contraseÃ±a">ğŸ‘</button>
              </div>
              <div id="password-match" class="login-password-match" style="display: none;"></div>
            </div>
            <div class="password-requirements" id="passwordReqs">
              <div id="req-length">â¬œ MÃ­nimo 8 caracteres</div>
              <div id="req-upper">â¬œ Al menos una mayÃºscula</div>
              <div id="req-number">â¬œ Al menos un nÃºmero</div>
            </div>
            <button type="submit" class="btn btn-login-gradient">
              Registrarse â†’
            </button>
          </form>

          <p class="login-switch-text" id="loginSwitchText">
            Â¿No tienes cuenta? <button type="button" id="linkToRegister" class="login-link-btn">RegÃ­strate gratis</button>
          </p>
          <p class="login-switch-text" id="registerSwitchText" style="display: none;">
            Â¿Ya tienes cuenta? <button type="button" id="linkToLogin" class="login-link-btn">Inicia sesiÃ³n</button>
          </p>

          <div id="message" class="login-message" style="display: none;"></div>

          <footer class="login-card-footer">
            <span class="login-card-footer-icon" aria-hidden="true">ğŸ”’</span>
            <span>Tus datos estÃ¡n protegidos y encriptados</span>
          </footer>
        </div>
      </div>
    </div>

    <!-- Modal OlvidÃ© mi contraseÃ±a -->
    <div id="modalForgotPass" class="modal-overlay is-hidden" aria-hidden="true">
      <div class="modal modal-forgot-pass" role="dialog" aria-labelledby="modalForgotPassTitle">
        <h2 id="modalForgotPassTitle" class="modal-title">Recuperar contraseÃ±a</h2>
        <p class="modal-forgot-pass-text">Ingresa el correo con el que te registraste. Te enviaremos un enlace para restablecer tu contraseÃ±a.</p>
        <form id="forgotPassForm" class="auth-form">
          <div class="field">
            <label class="label" for="forgotPassEmail">Correo</label>
            <input id="forgotPassEmail" class="input login-input" type="email" placeholder="tu@email.com" autocomplete="email" required />
          </div>
          <div id="forgotPassMessage" class="login-message" style="display: none;"></div>
          <div class="modal-forgot-pass-actions">
            <button type="button" id="forgotPassCancel" class="btn">Cancelar</button>
            <button type="submit" class="btn btn-primary btn-login-gradient">Enviar enlace</button>
          </div>
        </form>
        <button type="button" class="modal-close" id="forgotPassClose" aria-label="Cerrar">Ã—</button>
      </div>
    </div>

    <script>
      const API_URL = '';

      const tabLogin = document.getElementById('tabLogin');
      const tabRegister = document.getElementById('tabRegister');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const loginHeadLogin = document.getElementById('loginHeadLogin');
      const loginHeadRegister = document.getElementById('loginHeadRegister');
      const messageDiv = document.getElementById('message');
      const loginSwitchText = document.getElementById('loginSwitchText');
      const registerSwitchText = document.getElementById('registerSwitchText');

      if (localStorage.getItem('token')) {
        window.location.href = '/';
      }
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('reset') === 'ok') {
        showMessage('ContraseÃ±a actualizada. Ya puedes iniciar sesiÃ³n.');
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      function showLoginTab() {
        tabLogin.classList.add('is-active');
        tabRegister.classList.remove('is-active');
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        if (loginHeadLogin) loginHeadLogin.style.display = 'block';
        if (loginHeadRegister) loginHeadRegister.style.display = 'none';
        if (loginSwitchText) loginSwitchText.style.display = 'block';
        if (registerSwitchText) registerSwitchText.style.display = 'none';
        hideMessage();
      }

      function showRegisterTab() {
        tabRegister.classList.add('is-active');
        tabLogin.classList.remove('is-active');
        registerForm.style.display = 'block';
        loginForm.style.display = 'none';
        if (loginHeadLogin) loginHeadLogin.style.display = 'none';
        if (loginHeadRegister) loginHeadRegister.style.display = 'block';
        if (loginSwitchText) loginSwitchText.style.display = 'none';
        if (registerSwitchText) registerSwitchText.style.display = 'block';
        hideMessage();
      }

      tabLogin.addEventListener('click', showLoginTab);
      tabRegister.addEventListener('click', showRegisterTab);
      document.getElementById('linkToRegister').addEventListener('click', showRegisterTab);
      document.getElementById('linkToLogin').addEventListener('click', showLoginTab);
      const modalForgotPass = document.getElementById('modalForgotPass');
      const linkForgotPass = document.getElementById('linkForgotPass');
      const forgotPassForm = document.getElementById('forgotPassForm');
      const forgotPassEmail = document.getElementById('forgotPassEmail');
      const forgotPassMessage = document.getElementById('forgotPassMessage');
      const forgotPassCancel = document.getElementById('forgotPassCancel');
      const forgotPassClose = document.getElementById('forgotPassClose');

      function openForgotPassModal() {
        if (modalForgotPass) {
          modalForgotPass.classList.remove('is-hidden');
          modalForgotPass.setAttribute('aria-hidden', 'false');
          forgotPassEmail.value = '';
          forgotPassMessage.style.display = 'none';
        }
      }
      function closeForgotPassModal() {
        if (modalForgotPass) {
          modalForgotPass.classList.add('is-hidden');
          modalForgotPass.setAttribute('aria-hidden', 'true');
        }
      }

      linkForgotPass.addEventListener('click', (e) => {
        e.preventDefault();
        openForgotPassModal();
      });
      forgotPassCancel.addEventListener('click', closeForgotPassModal);
      forgotPassClose.addEventListener('click', closeForgotPassModal);
      modalForgotPass.addEventListener('click', (e) => { if (e.target === modalForgotPass) closeForgotPassModal(); });

      forgotPassForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = forgotPassEmail.value.trim();
        if (!email) return;
        forgotPassMessage.style.display = 'none';
        try {
          const res = await fetch(`${API_URL}/forgot-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const data = await res.json();
          forgotPassMessage.style.display = 'block';
          forgotPassMessage.className = 'login-message login-message--ok';
          forgotPassMessage.textContent = data.message || 'Si existe una cuenta con ese correo, recibirÃ¡s un enlace para restablecer la contraseÃ±a.';
          if (data.error) {
            forgotPassMessage.className = 'login-message login-message--error';
            forgotPassMessage.textContent = data.error;
          }
        } catch (err) {
          forgotPassMessage.style.display = 'block';
          forgotPassMessage.className = 'login-message login-message--error';
          forgotPassMessage.textContent = 'Error de conexiÃ³n.';
        }
      });

      function showMessage(text, isError = false) {
        messageDiv.textContent = text;
        messageDiv.style.display = 'block';
        messageDiv.className = 'login-message ' + (isError ? 'login-message--error' : 'login-message--ok');
      }

      function hideMessage() {
        messageDiv.style.display = 'none';
      }

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('loginUser').value.trim();
        const password = document.getElementById('loginPass').value;

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, password })
          });

          const data = await res.json();

          if (!res.ok) {
            showMessage(data.error || 'Error al iniciar sesiÃ³n', true);
            return;
          }

          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          showMessage('Â¡Bienvenido! Redirigiendo...');
          setTimeout(() => { window.location.href = '/'; }, 1000);
        } catch (err) {
          showMessage('Error de conexiÃ³n', true);
        }
      });

      const regPassInput = document.getElementById('regPass');
      regPassInput.addEventListener('input', () => {
        const password = regPassInput.value;
        updateReq('req-length', password.length >= 8);
        updateReq('req-upper', /[A-Z]/.test(password));
        updateReq('req-number', /[0-9]/.test(password));
      });

      function updateReq(id, valid) {
        const el = document.getElementById(id);
        if (!el) return;
        const text = el.textContent.substring(2).trim();
        el.textContent = (valid ? 'âœ… ' : 'â¬œ ') + text;
        el.style.color = valid ? '#0a0' : '#888';
      }

      const regPassConfirmInput = document.getElementById('regPassConfirm');
      const passwordMatchDiv = document.getElementById('password-match');

      function checkPasswordMatch() {
        const password = regPassInput.value;
        const confirmPassword = regPassConfirmInput.value;

        if (confirmPassword.length === 0) {
          passwordMatchDiv.style.display = 'none';
          return;
        }
        passwordMatchDiv.style.display = 'block';
        if (password === confirmPassword) {
          passwordMatchDiv.style.color = '#0a0';
          passwordMatchDiv.textContent = 'âœ… Las contraseÃ±as coinciden';
        } else {
          passwordMatchDiv.style.color = '#c00';
          passwordMatchDiv.textContent = 'âŒ Las contraseÃ±as no coinciden';
        }
      }

      regPassConfirmInput.addEventListener('input', checkPasswordMatch);
      regPassInput.addEventListener('input', checkPasswordMatch);

      function setupPasswordToggle(toggleBtnId, inputId) {
        const toggleBtn = document.getElementById(toggleBtnId);
        const input = document.getElementById(inputId);
        if (toggleBtn && input) {
          toggleBtn.addEventListener('click', () => {
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            toggleBtn.textContent = isPassword ? 'ğŸ™ˆ' : 'ğŸ‘';
            toggleBtn.setAttribute('aria-label', isPassword ? 'Ocultar contraseÃ±a' : 'Mostrar contraseÃ±a');
          });
        }
      }

      setupPasswordToggle('toggleLoginPass', 'loginPass');
      setupPasswordToggle('toggleRegPass', 'regPass');
      setupPasswordToggle('toggleRegPassConfirm', 'regPassConfirm');

      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('regUser').value.trim();
        const correo = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPass').value;
        const confirmPassword = document.getElementById('regPassConfirm').value;

        if (password !== confirmPassword) {
          showMessage('Las contraseÃ±as no coinciden', true);
          return;
        }

        try {
          const res = await fetch(`${API_URL}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, password, correo })
          });

          const data = await res.json();

          if (!res.ok) {
            let errorMsg = data.error || 'Error al registrar';
            if (data.details && data.details.length > 0) {
              errorMsg += ': ' + data.details.join(', ');
            }
            showMessage(errorMsg, true);
            return;
          }

          showMessage('Â¡Cuenta creada! Ahora puedes iniciar sesiÃ³n.');
          setTimeout(() => {
            showLoginTab();
            document.getElementById('loginUser').value = nombre;
          }, 1500);
        } catch (err) {
          showMessage('Error de conexiÃ³n', true);
        }
      });
    </script>
  </body>
</html>
