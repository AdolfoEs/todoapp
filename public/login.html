<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Mi To-Do App</title>
    <link rel="stylesheet" href="./style.css" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/icons/icon-192.svg" type="image/svg+xml" />
    <meta name="theme-color" content="#5b8cff" />
  </head>

  <body>
    <div class="app" role="application">
      <header class="header">
        <div>
          <h1 class="title">Mi To-Do App</h1>
          <p class="subtitle">Inicia sesi√≥n o crea una cuenta</p>
        </div>
      </header>

      <section class="panel">
        <!-- Tabs -->
        <div class="filters" role="tablist" style="margin-bottom: 20px;">
          <button class="chip is-active" id="tabLogin" type="button">Iniciar Sesi√≥n</button>
          <button class="chip" id="tabRegister" type="button">Registrarse</button>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="auth-form">
          <div class="field">
            <label class="label" for="loginUser">Usuario</label>
            <input id="loginUser" class="input" type="text" placeholder="Tu nombre de usuario" autocomplete="username" required />
          </div>
          <div class="field">
            <label class="label" for="loginPass">Contrase√±a</label>
            <div style="position: relative; width: 100%;">
              <input id="loginPass" class="input" type="password" placeholder="Tu contrase√±a" autocomplete="current-password" required style="padding-right: 45px; width: 100%;" />
              <button type="button" id="toggleLoginPass" class="password-toggle" aria-label="Mostrar contrase√±a" title="Mostrar contrase√±a">üëÅ</button>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
            Iniciar Sesi√≥n
          </button>
        </form>

        <!-- Register Form (hidden by default) -->
        <form id="registerForm" class="auth-form" style="display: none;">
          <div class="field">
            <label class="label" for="regUser">Usuario</label>
            <input id="regUser" class="input" type="text" placeholder="Elige un nombre de usuario" autocomplete="username" required />
          </div>
          <div class="field">
            <label class="label" for="regEmail">Correo (opcional)</label>
            <input id="regEmail" class="input" type="email" placeholder="tu@correo.com" autocomplete="email" />
          </div>
          <div class="field">
            <label class="label" for="regPass">Contrase√±a</label>
            <div style="position: relative; width: 100%;">
              <input id="regPass" class="input" type="password" placeholder="Contrase√±a segura" autocomplete="new-password" required minlength="8" style="padding-right: 45px; width: 100%;" />
              <button type="button" id="toggleRegPass" class="password-toggle" aria-label="Mostrar contrase√±a" title="Mostrar contrase√±a">üëÅ</button>
            </div>
            <div class="field">
              <label class="label" for="regPassConfirm">Confirmar Contrase√±a</label>
              <div style="position: relative; width: 100%;">
                <input id="regPassConfirm" class="input" type="password" placeholder="Repite tu contrase√±a" autocomplete="new-password" required minlength="8" style="padding-right: 45px; width: 100%;" />
                <button type="button" id="toggleRegPassConfirm" class="password-toggle" aria-label="Mostrar contrase√±a" title="Mostrar contrase√±a">üëÅ</button>
              </div>
              <div id="password-match" style="font-size: 12px; margin-top: 6px; display: none;"></div>
            </div>
            <div class="password-requirements" style="font-size: 12px; color: #888; margin-top: 6px;">
              <div id="req-length">‚¨ú M√≠nimo 8 caracteres</div>
              <div id="req-upper">‚¨ú Al menos una may√∫scula</div>
              <div id="req-lower">‚¨ú Al menos una min√∫scula</div>
              <div id="req-number">‚¨ú Al menos un n√∫mero</div>
              <div id="req-symbol">‚¨ú Al menos un s√≠mbolo (!@#$%...)</div>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
            Crear Cuenta
          </button>
        </form>

        <!-- Messages -->
        <div id="message" class="message" style="margin-top: 16px; display: none;"></div>
      </section>

      <footer class="footer">
        <span>Frontend: HTML/CSS/JS</span>
        <span class="dot">‚Ä¢</span>
        <span>Backend: Node + Express</span>
        <span class="dot">‚Ä¢</span>
        <span>DB: SQLite</span>
      </footer>
    </div>

    <script>
      const API_URL = '';
      
      // Elementos
      const tabLogin = document.getElementById('tabLogin');
      const tabRegister = document.getElementById('tabRegister');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const messageDiv = document.getElementById('message');

      // Si ya hay token, ir a la app
      if (localStorage.getItem('token')) {
        window.location.href = '/';
      }

      // Cambiar tabs
      tabLogin.addEventListener('click', () => {
        tabLogin.classList.add('is-active');
        tabRegister.classList.remove('is-active');
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        hideMessage();
      });

      tabRegister.addEventListener('click', () => {
        tabRegister.classList.add('is-active');
        tabLogin.classList.remove('is-active');
        registerForm.style.display = 'block';
        loginForm.style.display = 'none';
        hideMessage();
      });

      // Mostrar mensaje
      function showMessage(text, isError = false) {
        messageDiv.textContent = text;
        messageDiv.style.display = 'block';
        messageDiv.style.padding = '12px';
        messageDiv.style.borderRadius = '8px';
        messageDiv.style.backgroundColor = isError ? '#fee' : '#efe';
        messageDiv.style.color = isError ? '#c00' : '#060';
        messageDiv.style.border = isError ? '1px solid #fcc' : '1px solid #cfc';
      }

      function hideMessage() {
        messageDiv.style.display = 'none';
      }

      // Login
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('loginUser').value.trim();
        const password = document.getElementById('loginPass').value;

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, password })
          });

          const data = await res.json();

          if (!res.ok) {
            showMessage(data.error || 'Error al iniciar sesi√≥n', true);
            return;
          }

          // Guardar token y datos del usuario
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          
          showMessage('¬°Bienvenido! Redirigiendo...');
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);

        } catch (err) {
          showMessage('Error de conexi√≥n', true);
        }
      });

      // Validaci√≥n de contrase√±a en tiempo real
      const regPassInput = document.getElementById('regPass');
      regPassInput.addEventListener('input', () => {
        const password = regPassInput.value;
        
        updateReq('req-length', password.length >= 8);
        updateReq('req-upper', /[A-Z]/.test(password));
        updateReq('req-lower', /[a-z]/.test(password));
        updateReq('req-number', /[0-9]/.test(password));
        updateReq('req-symbol', /[!@#$%^&*(),.?":{}|<>_\-]/.test(password));
      });

      function updateReq(id, valid) {
        const el = document.getElementById(id);
        if (valid) {
          el.style.color = '#0a0';
          el.textContent = '‚úÖ ' + el.textContent.substring(2);
        } else {
          el.style.color = '#888';
          el.textContent = '‚¨ú ' + el.textContent.substring(2);
        }
      }

      // Validaci√≥n de confirmaci√≥n de contrase√±a
      const regPassConfirmInput = document.getElementById('regPassConfirm');
      const passwordMatchDiv = document.getElementById('password-match');

      function checkPasswordMatch() {
        const password = regPassInput.value;
        const confirmPassword = regPassConfirmInput.value;
        
        if (confirmPassword.length === 0) {
          passwordMatchDiv.style.display = 'none';
          return;
        }

        passwordMatchDiv.style.display = 'block';
        if (password === confirmPassword) {
          passwordMatchDiv.style.color = '#0a0';
          passwordMatchDiv.textContent = '‚úÖ Las contrase√±as coinciden';
        } else {
          passwordMatchDiv.style.color = '#c00';
          passwordMatchDiv.textContent = '‚ùå Las contrase√±as no coinciden';
        }
      }

      regPassConfirmInput.addEventListener('input', checkPasswordMatch);
      regPassInput.addEventListener('input', checkPasswordMatch);

      // Toggle mostrar/ocultar contrase√±a
      function setupPasswordToggle(toggleBtnId, inputId) {
        const toggleBtn = document.getElementById(toggleBtnId);
        const input = document.getElementById(inputId);
        
        if (toggleBtn && input) {
          toggleBtn.addEventListener('click', () => {
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            toggleBtn.textContent = isPassword ? 'üôà' : 'üëÅ';
            toggleBtn.setAttribute('aria-label', isPassword ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a');
          });
        }
      }

      // Configurar toggles para todos los campos de contrase√±a
      setupPasswordToggle('toggleLoginPass', 'loginPass');
      setupPasswordToggle('toggleRegPass', 'regPass');
      setupPasswordToggle('toggleRegPassConfirm', 'regPassConfirm');

      // Register
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('regUser').value.trim();
        const correo = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPass').value;
        const confirmPassword = document.getElementById('regPassConfirm').value;

        // Verificar que las contrase√±as coincidan
        if (password !== confirmPassword) {
          showMessage('Las contrase√±as no coinciden', true);
          return;
        }

        try {
          const res = await fetch(`${API_URL}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nombre, password, correo })
          });

          const data = await res.json();

          if (!res.ok) {
            let errorMsg = data.error || 'Error al registrar';
            if (data.details && data.details.length > 0) {
              errorMsg += ':\n‚Ä¢ ' + data.details.join('\n‚Ä¢ ');
            }
            showMessage(errorMsg, true);
            return;
          }

          showMessage('¬°Cuenta creada! Ahora puedes iniciar sesi√≥n.');
          // Cambiar a tab de login
          setTimeout(() => {
            tabLogin.click();
            document.getElementById('loginUser').value = nombre;
          }, 1500);

        } catch (err) {
          showMessage('Error de conexi√≥n', true);
        }
      });
    </script>
  </body>
</html>
